document.addEventListener('DOMContentLoaded', async () => {
    const SUPABASE_URL = 'https://ymvpaooxdqhayzcumrpj.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_TdMi6H9GkduboyrDAf0L3g_Ct5C7Wqy';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let participantes = [];
    let resultados = [];
    let finanzas = {};

    async function cargarPublico() {
        const { data, error } = await _supabase.from('polla_datos').select('*');
        if (error) return;

        data.forEach(item => {
            if (item.tipo === 'participantes') participantes = item.contenido || [];
            if (item.tipo === 'resultados') resultados = item.contenido || [];
            if (item.tipo === 'finanzas') finanzas = item.contenido || {};
        });

        actualizarUI();
    }

    function actualizarUI() {
        // Actualizar cuadros de montos
        const totalVentas = finanzas.ventas || 0;
        const totalRecaudado = finanzas.recaudado || 0;
        
        document.getElementById('total-jugadas').innerText = totalVentas;
        document.getElementById('monto-recaudado').innerText = `Bs.${totalRecaudado}`;
        
        // Calcular aciertos y mostrar ranking
        const lista = document.getElementById('tabla-ranking');
        if (!lista) return;

        const ganadores = resultados.map(r => r.numero);
        
        lista.innerHTML = participantes.map((p, i) => {
            const aciertos = p.jugada.filter(n => ganadores.includes(n)).length;
            return `
                <tr>
                    <td>${i + 1}</td>
                    <td>${p.nombre}</td>
                    <td>${p.refe}</td>
                    <td>${p.jugada.join(' - ')}</td>
                    <td class="aciertos">${aciertos}</td>
                </tr>
            `;
        }).join('');
    }

    cargarPublico();
});